# 跨地域Web安全加速（大陆域名）

全球加速（GA）依托阿里巴巴优质BGP带宽和全球传输网络，通过联动内容分发网络（CDN）、DDoS高防、Web应用防火墙（WAF）和全局流量管理（GTM），为Web服务商提供一套高安全的跨地域加速方案。

开始前，请确保满足以下条件：

-   您已经注册了阿里云账号。如未注册，请先完成[账号注册](https://account.alibabacloud.com/register/intl_register.htm)。
-   您的网站已经完成备案。

某Web服务部署在美国（硅谷）地域的阿里云上，后端服务器为4个绑定了阿里云弹性公网IP的ECS实例，中国内地用户通过域名www.example.com（大陆域名）访问Web服务，转发端口为TCP 9000端口。该Web服务面临以下问题：

-   Web服务经常受到各类Web攻击和DDoS攻击，严重影响Web应用服务的安全性和可用性。
-   跨国公网不稳定，经常出现延迟、抖动、丢包等网络问题。
-   后端服务器不稳定，业务存在中断的风险。

![有备案](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2272958951/p99746.png)

如上图部署架构，您可以联动部署全球加速、CDN、DDoS高防、Web应用防火墙、全局流量管理。部署完成后，可以有效解决跨域Web服务面临的问题。

-   CDN加速Web内容的分发，提高资源访问速度。

    CDN将源站资源缓存至阿里云遍布全球的加速节点上，当客户端请求访问和获取该资源时，无需回源，系统自动调用离客户端最近的CDN节点上已缓存的资源。

-   DDoS高防可以有效防御DDoS攻击。

    所有访问Web的公网流量都会经过高防机房，恶意攻击流量将在高防流量清洗中心进行清洗过滤，正常的访问流量通过端口协议转发的方式返回给源站服务器。

-   Web应用防火墙可以有效防御各类Web攻击。

    所有访问Web的公网流量都会经过Web应用防火墙，恶意攻击流量在Web应用防火墙上被检测过滤，而正常流量返回给源站，确保源站安全、稳定、可用。

-   全球加速可以提高加速区域用户的网络访问速度。

    上海、杭州和深圳用户的访问请求通过加速IP就近从接入点进入阿里云加速网络 ，然后通过智能选择路由和自动网络调度，把网络访问请求送达至美国硅谷源站。

-   全局流量管理可以实现故障隔离或流量切换。
    -   如果主服务器组运行正常时，客户端的访问流量均转发到主服务器组。
    -   如果主服务器组因故障不可用时，流量迅速切换到备服务器组，并在主服务器组恢复正常后，客户端流量切回主服务器组。

## 配置步骤

![跨域Web安全加速配置步骤](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3272958951/p99825.png)

## 步骤一：创建全局流量管理实例

全局流量管理是一种流量管理服务，可以帮助您精细化的管理客户端访问流量。

完成以下操作，创建全局流量管理实例。

1.  登录[阿里云云解析DNS控制台](https://dns.console.aliyun.com)。

2.  在左侧导航栏，单击**全局流量管理**。

3.  在**全局流量管理**页面，单击**创建实例**。

4.  在购买页面，根据以下信息配置全局流量管理实例。

    1.  **套餐版本**：默认为**标准版**，且不支持修改。

        标准版套餐说明如下：

        -   支持应用服务IP地址健康检查。
        -   支持DNS按照区域进行智能解析。
        -   支持配置DNS故障容灾策略。
        -   支持配置流量均衡策略。
    2.  **购买数量**：选择购买实例的数量。

    3.  **购买时长**：选择购买实例的时长。

5.  单击**立即购买**完成支付。


## 步骤二：配置访问策略

访问策略可以将不同来源的访问请求转发到不同的后端服务器，并可以根据实际业务需要设置备用后端服务器。

完成以下操作，为全局流量管理配置访问策略。

1.  登录[阿里云云解析DNS控制台](https://dns.console.aliyun.com)。

2.  在左侧导航栏，单击**全局流量管理**。

3.  在**全局流量管理**页面，找到目标全局流量管理实例，单击**操作**列下的**配置**。

4.  在**选择配置方法**对话框，选择**快速入门**。

5.  在**访问策略配置**向导下，根据以下信息配置访问策略。

    1.  **策略名称**：输入访问策略的名称。

    2.  **解析请求来源**： 选择解析请求来源。

        选中解析请求来源后，该区域的用户访问应用服务时会智能调度到所配置的后端服务器地址池。本方案选择**全局**。

    3.  **默认地址池**：选择默认地址池。

        默认地址池是业务正常情况下，全局流量管理将用户访问流量转发到的后端服务器地址池。

        本方案您需要先单击**+新增地址**，将美国源站服务器1和服务器2添加到默认地址池，并配置健康检查，然后再选择默认地址池。健康检查配置详情，请参见[TCP健康检查](https://www.alibabacloud.com/help/zh/doc-detail/87312.htm)。

    4.  **备用地址池**：选择备用地址池。

        备用地址池是在默认地址池中的服务器因故障不可用时，全局流量管理将用户访问流量切换到的后端服务器地址池。

        本方案您需要单击**+新增地址**，将美国源站服务器3和服务器4添加到备用地址池，并配置健康检查，然后再选择备用地址池。健康检查配置详情，请参见[TCP健康检查](https://www.alibabacloud.com/help/zh/doc-detail/87312.htm)。

6.  单击**下一步**。


## 步骤三：配置基础信息

配置访问策略后，您需要配置全局流量管理实例的基础信息，包括主域名信息、CNAME接入域名、负载均衡策略、全局TTL、报警通知组等相关信息。

完成以下操作，为全局流量管理配置基础信息。

1.  在**基础信息**向导下，配置基础信息。

    1.  **实例名称**：输入实例名称。

        实例名称是便于识别该实例用于某个应用服务的标识。

    2.  **主域名**：输入客户端访问的域名。本方案输入**www.example.com**。

    3.  **CNAME接入域名**：选择接入域名的类型。

        -   **系统分配接入域名**：适用于后端服务地址池中都是阿里云地址或海外地址。
        -   **自定义接入域名**：适用于后端服务地址池中有自建IDC的地址。
        本方案中，后端服务地址均为阿里云弹性公网IP，所以选择系统分配接入域名。

    4.  **均衡策略**：选择全局流量管理的均衡策略。

        -   **负载均摊**：域名解析到多个IP地址时，采用负载平均分配的策略。
        -   **加权轮询**：域名解析到多个IP地址时，基于预置权重采用轮询的策略。
        本方案选择**负载均摊**。

    5.  **全局TTL**：域名解析对应IP地址的生效时间。本方案选择**1分钟**。

        全局流量管理是以域名形式对外提供流量管理服务，全局TTL即域名对应IP地址信息在运营商DNS系统内的缓存生效时间，默认提供1分钟的TTL时间。如果使用自定义接入域名方式，全局TTL需要与自定义域名的云解析套餐支持的最小TTL保持一致。

    6.  **报警通知组**：当业务出现异常时，用于接收通知消息的联系组。

        **说明：**

        -   如果您未配置报警通知组，请先前往云监控控制台设置。详细信息，请参见[t6224.md\#](/intl.zh-CN/报警服务/报警联系人/删除报警联系人或报警联系组.md)。
        -   如果您已经配置了报警通知组，但您使用子账号配置基础信息，请先使用主账号授权。授权成功后，子账号才能读取到报警通知组信息。
2.  单击**完成**。


基本信息配置完成后，系统会自动分配一个CNAME接入域名用于解析要调度的后端服务IP。

![cname](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5496958951/p99619.png)

## 步骤四：创建全球加速实例

全球加速实例是一个运行的全球加速服务。

完成以下操作，创建全球加速实例。

1.  登录[全球加速管理控制台](https://ga.console.aliyun.com/list)。

2.  在**实例列表**页面，单击**创建加速实例**。

3.  在购买页面，根据以下信息配置全球加速实例，然后单击**立即购买**。

    1.  选择购买全球加速实例的规格。本方案选择**中型Ⅰ**。

        全球加速支持小型Ⅰ、小型Ⅱ、小型Ⅲ、中型Ⅰ、中型Ⅱ、中型Ⅲ六种规格，每种规格提供的加速服务如下表所示。

        |规格|加速地域个数|最大带宽处理能力|最大并发连接数|
        |--|------|--------|-------|
        |小型Ⅰ|1|20 Mbps|5000|
        |小型Ⅱ|2|40 Mbps|10000|
        |小型Ⅲ|3|60 Mbps|15000|
        |中型Ⅰ|5|100 Mbps|25000|
        |中型Ⅱ|8|160 Mbps|40000|
        |中型Ⅲ|10|200 Mbps|50000|

    2.  选择购买全球加速实例的时长。


实例创建成功后，系统会自动分配一个CNAME用于解析要加速的后端服务的域名。

![CNAME](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5496958951/p84125.png)

## 步骤五：购买并绑定基础带宽包

基础带宽包提供了覆盖全球的公网接入带宽和阿里云内网传输带宽。实现全球加速您需要购买基础带宽包并将基础带宽包绑定到全球加速实例。

完成以下操作，购买并绑定基础带宽包。

1.  在**实例列表**页面，单击**购买基础带宽包**。

2.  在购买页面，配置基础带宽包，然后单击**立即购买**完成支付。

    1.  **带宽类型**：选择购买基础带宽包的带宽类型。本方案选择**标准加速带宽**。

        基础带宽包支持标准加速带宽、增强加速带宽和精品加速带宽三种带宽类型。带宽类型不同，加速类型、加速后端服务和加速范围也不同，如下表所示。

        |带宽类型|加速类型|加速后端服务|加速范围|
        |----|----|------|----|
        |标准加速带宽|阿里云上应用加速|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP

**说明：** 不支持加速经典网络类型的ECS实例和经典网络类型的SLB实例。

|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |增强加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |精品加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速全球区域（中国内地到海外区域间的加速通过中国香港加速点上车），选配跨域加速包后会进一步优化中国内地-海外间的网络加速效果|

        **说明：** 目前，将云服务器和负载均衡作为终端节点的功能白名单开放。如需使用，请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

    2.  **带宽峰值**：选择购买基础带宽包的带宽峰值。本方案选择**10Mb**。

    3.  **购买时长**：选择购买基础带宽包的时长。

3.  返回**实例列表**页面，单击已创建的全球加速实例ID。

4.  单击**带宽包管理**页签。

5.  在**基础带宽包**区域，找到目标基础带宽包，单击**操作**列下的**绑定**。

    ![绑定](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3405588951/p95529.png)

    绑定成功后，基础带宽包的状态变成**可用**。


## 步骤六：添加加速区域

在购买基础带宽包后，您便可以添加加速区域，指定访问后端服务的用户的所在地域并分配加速带宽。

完成以下操作，添加加速区域。

1.  在**实例列表**页面，单击步骤四中创建的全球加速实例ID。

2.  在实例详情页，单击**加速区域**页签，然后单击**添加加速区域**。

3.  在**添加加速区域**对话框，配置加速区域和接入区域，然后单击**确定**。

    1.  **加速区域**：选择需要进行访问加速的区域。本方案选择**华东**。

    2.  **地域**：选择访问加速服务用户的所属地域。本方案选择**杭州**。

    3.  **带宽**：选择加速服务的地域带宽。本方案选择**2**Mbps。

    4.  单击**+添加**，选择上海为加速地域，并为上海地域分配2Mbps带宽。

4.  重复上述步骤，添加华南区域的深圳地域为加速地域，并为深圳地域分配2Mbps带宽。


加速区域添加成功后，全球加速会为每个加速区域中的地域分配一个加速IP，用来加速用户访问。

![添加加速区域](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3405588951/p95535.png)

## 步骤七：创建监听

监听负责检查连接请求。系统会根据您指定的端口和协议转发来自客户端的入站连接。

完成以下操作，为全球加速实例创建监听。

1.  在**实例列表**页面，单击步骤四中创建的全球加速实例ID。

2.  在实例详情页，单击**监听**页签，然后单击**添加监听**。

3.  在**监听&协议**页面，配置监听。

    1.  **监听名称**：输入监听的名称。 名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短横线（-）。

    2.  **协议**：选择监听的协议类型。本方案选择**TCP**。

    3.  **端口**：指定用来接收请求并向终端节点进行转发的监听端口，端口取值范围：1~65499。本方案输入**9000**。

    4.  **客户端亲和性**：选择是否保持客户端亲和性。保持客户端亲和性，即客户端访问有状态的应用程序时，可以将来自同一客户端的所有请求都定向到同一终端节点。本方案选择**源IP**。

    ![监听](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4405588951/p95540.png)

4.  单击**下一步**配置终端节点组。


## 步骤八：设置终端节点组

每个监听都关联一个终端节点组，通过指定要分发流量的地域，将终端节点组与监听关联。关联后，全球加速会将流量分配到与监听关联的终端节点组内的最佳终端节点。

完成以下操作，设置终端节点组。

1.  在**节点组名称**区域输入节点组名称。

2.  选择终端节点组所属的地域，即请求要访问的目标服务器的所属地域。

    本方案选择**美国硅谷**。

3.  选择后端服务部署在阿里云还是非阿里云。本方案选择**非阿里云**。

4.  选择开启或关闭保持客户端源IP。开启后，后端服务器可以通过该功能获取客户端源IP。本教程选择关闭保持客户端源IP。

    **说明：** 目前，保持客户端源IP功能白名单开放，如需使用请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

5.  配置终端节点。

    1.  **后端服务类型**：选择**自定义域名**。

    2.  **后端服务**：输入步骤三配置基础信息后分配的CNAME地址。详细信息，请参见[步骤三：配置基础信息](#section_fdd_3lq_0qt)。

    3.  **权重**：输入终端节点的权重，权重取值范围：0~255。全球加速根据您配置的权重按比例将流量路由到终端节点。

        **说明：** 如果某个终端节点的权重设置为0，全球加速将终止向该终端节点分发流量，请您谨慎操作。

    ![endpoint](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5496958951/p99230.png)

6.  单击**下一步**查看监听和终端节点组配置，确认无误后，再单击**下一步**。


## 步骤九：购买并绑定跨域加速带宽包

跨域加速带宽包可以优化中国内地与海外区域间的网络加速。

完成以下操作，购买跨域加速带宽包并将跨域加速带宽包绑定到全球加速实例。

1.  在**实例列表**页面，单击**购买跨域加速带宽包**。

2.  在购买页面，配置跨域加速带宽包，然后单击**立即购买**完成支付。

    1.  **区域-A**：选择要互通的区域。本方案选择**中国内地**。

    2.  **区域-B**：选择要互通的区域。

        -   **全球**：客户端的访问请求根据客户端所属的加速地域自动选择全球最优出口。
        -   **香港**：客户端的访问请求统一从香港出口。
        本方案选择**全球**。

    3.  **计费方式**：选择跨域加速带宽包的计费方式。 目前，仅支持**按固定带宽计费**。

    4.  **带宽值**：选择跨域加速带宽包的带宽值。

        建议您购买的跨域加速带宽包的带宽值与基础带宽包的带宽值相同。本方案选择**10Mb**。

    5.  **购买时长**：选择购买时长。

3.  返回**实例列表**页面，找到目标全球加速实例，单击实例ID链接。

4.  单击**带宽包管理**页签。

5.  在**跨域加速带宽包**区域，找到目标跨域加速带宽包，单击**操作**列下的**绑定**。

    ![绑定](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4405588951/p95548.png)

    绑定成功后，跨域加速带宽包的状态变成**可用**。


## 步骤十：开通Web应用防火墙

Web应用防火墙WAF基于云安全大数据能力，用于防御SQL注入、XSS跨站脚本、常见Web服务器插件漏洞、木马上传、非授权核心资源访问等OWASP常见攻击，并过滤海量恶意CC攻击，避免您的网站资产数据泄露，保障网站的安全与可用性。

本方案以包年包月为例，介绍如何开通Web应用防火墙。

1.  进入阿里云官网[Web应用防火墙产品详情页](https://www.alibabacloud.com/zh/product/waf)。

2.  单击**立即购买**。

3.  在**Web应用防火墙**页面，完成以下配置。

    1.  **地域**：选择WAF服务主机所在地域。

        本方案选择**中国内地**。

    2.  **版本**：选择要开通的WAF服务的版本。

        不同WAF版本适用的业务规模和支持的防护功能不同。详细信息，请参见[套餐规格与功能说明](/intl.zh-CN/产品简介/套餐规格与功能说明.md)。本方案选择**企业版**。

    3.  **扩展域名包**：指定要开通的扩展域名包数量。

        当您有多个域名（或超过10个子域名）需要接入WAF进行防护时，您可以开通域名扩展包。详细信息，请参见[域名扩展包](/intl.zh-CN/产品计费/开通WAF/扩展域名包.md)。本方案不购买域名扩展包。

    4.  **域名独享IP包**：指定要开通的独享IP数量。

        当您有重要的域名需要使用独立的WAF IP进行防护时，您可以开通域名独享IP包。详细信息，请参见[独享IP包](/intl.zh-CN/产品计费/开通WAF/域名独享资源包.md)。本方案不购买域名独享资源包。

    5.  **扩展带宽包**：指定要开通的扩展带宽包大小，单位Mbps。

        当您需要接入WAF进行防护的业务总带宽超过所选套餐规格时，您可以开通扩展带宽包。详细信息，请参见[额外带宽扩展包](/intl.zh-CN/产品计费/开通WAF/额外带宽扩展说明.md)。本方案选择**100Mbps**。

    6.  **全局负载均衡**：选择开启或关闭全局负载均衡。

        全局负载均衡通过多节点智能接入技术，助力业务支持多节点、多线路自动调度容灾，提高业务的可靠性。本方案选择**否**。

    7.  **日志存储服务**：选择开启或关闭日志存储服务。

        日志存储服务将WAF所有的日志信息实时存储至日志服务存储空间中，同时提供查询分析和展示在线报表等功能。本方案选择**否**。

    8.  **Bot管理**：选择开启或关闭Bot管理功能。

        如果您需要缓解机器流量对业务造成的安全威胁，您可以开通Bot管理功能模块。详细信息，请参见[设置爬虫威胁情报规则](/intl.zh-CN/网站防护配置/Bot管理/设置爬虫威胁情报规则.md)和[设置合法爬虫规则](/intl.zh-CN/网站防护配置/Bot管理/设置合法爬虫规则.md)。本方案选择**否**。

    9.  **APP防护**：选择开启或关闭APP防护。

        如果您的业务支持原生APP端且存在可信通信、防机器脚本滥刷等安全需求，您可以开通APP防护。详细信息，请参见[设置App防护](/intl.zh-CN/网站防护配置/Bot管理/App防护/设置App防护.md)。本方案选择**否**。

    10. **购买时长**：选择WAF服务的有效时长。


## 步骤十一：添加网站配置

完成以下操作，将被防护域名的访问流量指向WAF。

1.  在顶部状态栏，选择Web应用防火墙实例的地域。本方案选择**中国内地**。

2.  在左侧导航栏，选择**资产中心** \> **网站接入**。

3.  在**网站接入**页面，单击**添加域名**。

4.  根据配置向导完成相关任务。

    1.  **域名**：输入要防护的域名。 本方案输入**www.example.com**。

        **说明：**

        -   支持使用精确域名（例如`www.aliyun.com`）和泛域名（例如`*.aliyun.com`）格式。
            -   使用泛域名后，Web应用防火墙将自动匹配该泛域名对应的子域名。
            -   如果同时存在泛域名和精确域名配置，则精确域名的转发规则和防护策略优先生效。
        -   暂不支持添加`.edu`域名。如果您需要添加`.edu`域名，请提交工单联系售后技术支持。
    2.  **服务器地址**：选择服务器地址类型，然后输入网站的源站服务器地址。

        支持**IP地址**和**其他**格式。网站接入WAF后，WAF将过滤后的访问请求转发至该地址。本方案选择**其他**，然后输入步骤四创建全球加速实例后系统分配的CNAME地址。详细信息，请参见[步骤四：创建全球加速实例](#section_efv_yl1_8q1)。

    3.  **负载均衡算法**：如果配置了多个源站IP，勾选**IP hash**、**轮询**或**Least time**。WAF将根据所选择的方式在多个源站IP间分发访问请求，实现负载均衡。本方案选中**Least time**。

        **说明：** **Least time**仅在开通智能负载均衡后才支持使用。更多信息，请参见[智能负载均衡接入能力](/intl.zh-CN/产品计费/开通WAF/智能负载均衡接入能力.md)。


## 步骤十二：开通DDoS高防（新BGP）实例

DDoS高防（新BGP）拥有中国内地最大的BGP带宽资源，最高防护带宽达到1.5T，可以应对超大流量攻击。

完成以下操作，开通DDoS高防（新BGP）实例。

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在**实例列表**页面，单击**新购实例**。

3.  在购买页面，完成DDoS高防（新BGP）实例的购买配置。

    1.  **防护套餐**：默认为**专业版**，且不支持修改。

    2.  **保底防护带宽**：选择DDoS高防（新BGP）实例的保底防护带宽。本方案选择**30Gb**。

    3.  **弹性防护带宽**：选择DDoS高防（新BGP）实例的最大弹性防护带宽，对于超出保底防护带宽的攻击进行弹性防护。选方案选择**300Gb**。

    4.  **资源组**：选择DDoS高防（新BGP）实例所属的资源组。

    5.  **业务带宽**：选择DDoS高防（新BGP）实例的业务带宽，业务带宽即在无攻击状态下本实例最大可容纳的正常业务流量。本方案选择**100Mbps**。

    6.  **功能套餐**：选择功能套餐，支持**标准功能**和**增强功能**。本方案选择**增强功能**。

        关于标准功能和增强功能的差异，请参见[DDoS高防（新BGP&国际）功能套餐](/intl.zh-CN/产品计费/DDoS高防（新BGP&国际）功能套餐.md)。

    7.  **防护域名数**：选择支持接入防护的HTTP/HTTPS域名数量。本方案选择**50**。

        关于防护域名数的详细说明，请参见[防护域名数]()。

    8.  **业务QPS**：选择业务QPS，业务QPS是无攻击状态下本实例最大可容纳HTTP/HTTPS的并发请求速率。本方案选择**3000**。

    9.  **防护端口数**：选择支持的最大转发端口数量，即通过TCP/UDP协议转发支持的最大条目数。本方案选择**50**。

    10. **购买数量**：选择购买当前配置的实例的数量。

    11. **购买时长**：选择要购买实例的有效期。

4.  单击**立即购买**并完成支付。


## 步骤十三：添加网站配置

网站业务接入DDoS高防时，您必须在DDoS高防中为其添加网站配置。网站配置定义了接入DDoS高防的网站业务的流量转发信息。

完成以下操作，添加网站配置。

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在顶部状态栏，选择服务所在地域。

    本方案中流量经DDoS高防（新BGP）防护后转发给Web应用防火墙，所以选择**中国内地**。

3.  在左侧导航栏，单击**接入管理** \> **域名接入**。

4.  在**域名接入**页面，单击**添加网站**。

5.  在**添加网站**页面，填写网站信息。

    1.  **功能套餐**：选择要关联的DDoS高防实例的功能套餐规格。支持**标准功能**和**增强功能**。

        关于不同功能套餐的详细信息，请参见[DDoS高防（新BGP&国际）功能套餐](/intl.zh-CN/产品计费/DDoS高防（新BGP&国际）功能套餐.md)。本方案选择**增强功能**。

    2.  **实例**：勾选要关联的DDoS高防实例。

        一个网站域名最多支持关联八个DDoS高防实例，且不支持关联不同功能套餐的实例。

    3.  **网站**：输入要防护的网站域名。

        **说明：**

        -   根据域名命名规则，域名可以由26个英文字母（a-z、A-Z，不区分大小写）、数字（0-9）以及连接符（-）组成，但是域名的首位必须是字母或数字。
        -   支持填写泛域名，如`*.aliyun.com`。DDoS高防自动匹配该泛域名对应的子域名。
        -   如果同时存在泛域名和精确域名配置（如`*.aliyun.com`和`www.aliyun.com`），DDoS高防优先使用精确域名所配置的转发规则和防护策略。
        本方案输入**www.example.com**。

    4.  **协议类型**：选择网站支持的协议类型。本方案保持默认选择的**HTTP**和**HTTPS**。

    5.  **启用HTTP2**：域名关联增强功能的高防实例时，选择是否开启HTTP2。开启后协议版本为HTTP2.0。

    6.  **服务器地址**：选择源站地址类型，并指定源站服务器地址。本方案选择**源站域名**，然后输入步骤十一添加网站配置后分配的CNAME。详细信息，请参见[步骤十一：添加网站配置](#section_3z7_1w8_7lv)。

    7.  **服务器端口**：根据选择的协议类型指定服务器端口。 本方案指定端口为**9000**。

6.  单击**添加**。


添加网站配置后，DDoS高防为网站分配一个CNAME地址。

![cname](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4272958951/p99747.png)

## 步骤十四：开通CDN服务

CDN分担源站压力，避免网络拥塞，确保在不同区域、不同场景下加速网站内容的分发，提高资源访问速度。

完成以下操作，开通CDN服务。

1.  登录[阿里云CDN平台](https://www.alibabacloud.com/en/product/cdn)。

2.  单击**立即购买**。

3.  在**云产品开通页**，选择适合您的**计费类型**。

    CDN的计费方式请参见[计费方式](https://www.alibabacloud.com/zh/product/cdn/pricing)。

    ![云产品开通页](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4078749951/p66557.png)

4.  选中**我已阅读并同意**复选框，单击**立即开通**。


## 步骤十五：添加加速域名

CDN通过加速域名将源站上的资源缓存到CDN的加速节点，实现资源访问加速。

完成以下操作，添加加速域名。

1.  登录[CDN控制台](https://cdn.console.aliyun.com)。

2.  在左侧导航栏，单击**域名管理**。

3.  在**域名管理**页面，单击**添加域名**。

4.  在**添加域名**页面，配置域名。

    1.  **加速域名**：输入Web域名。本方案输入**www.example.com**。

        **说明：**

        -   加速域名一般使用子域名或泛域名，例如：`cdntest.example.com`。
        -   支持泛域名加速，不支持中文域名加速，请注意泛域名填写规则，例如 `*.test.com`。详细规则请参见[泛域名加速规则]()。
        -   加速域名不允许重复添加，例如出现**域名已添加**的提示，请[提交工单处理](https://selfservice.console.aliyun.com/ticket/createIndex)。
        -   如果泛域名未被添加到任何CDN账号下，则其支持多个CDN账号添加不同的子域名。
        -   每个账户下最多支持50个加速域名，如需扩容请[提交工单处理](https://selfservice.console.aliyun.com/ticket/createIndex)。
        -   加速内容必须合法且符合CDN业务规范，详情请参见 [CDN服务使用限制](/intl.zh-CN/产品简介/使用限制.md)。
    2.  **业务类型**：选择您网站的业务类型。

        -   **图片小文件**：如果您网站的加速内容多为小型的静态资源 （例如小文件、图片、网页样式文件等），推荐您选择该业务类型。详细信息，请参见[图片小文件](/intl.zh-CN/产品简介/应用场景/图片小文件.md)。
        -   **大文件下载**：如果您网站的加速内容为较大的文件（大于20MB的静态文件），例如游戏安装包、应用更新、手机ROM升级、应用程序包下载等场景，推荐选择该业务类型。详细信息，请参见[大文件下载](/intl.zh-CN/产品简介/应用场景/大文件下载.md)。
        -   **视音频点播**：如果您网站的加速内容为音频或视频文件，例如音乐、视频的点播业务场景，推荐选择该业务类型。详细信息，请参见[视音频点播](/intl.zh-CN/产品简介/应用场景/视音频点播.md)。
        -   **全站加速**：如果您的网站含有大量动静态混合内容，且较多为动态资源请求，您可以使用全站加速。详细信息，请参见[全站加速](/intl.zh-CN/产品简介/应用场景/全站加速.md)。
        本方案选择**图片小文件**。

    3.  **源站信息**：配置CDN的源站信息。

        本方案选择**源站域名**，然后输入步骤十三添加网站配置后分配的CNAME。详细信息，请参见[步骤十三：添加网站配置](#section_4fz_7a3_e7e)。

    4.  **端口**：选择网站访问端口。

        -   **80端口**：以HTTP协议访问资源。
        -   **443端口**：以HTTPS协议访问资源。
        本方案选择**80端口**。

    5.  **加速区域**：选择要加速的区域。本方案选择**仅中国内地**。

5.  单击**下一步**。

    加速域名添加成功后，阿里云CDN会分配对应的CNAME地址。

    ![cname](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9472029951/p99749.png)


## 步骤十六：将DNS解析到CDN

域名添加成功后，您需要将DNS解析到CDN，访问加速域名的请求才能转发到CDN节点，达到加速效果。

**说明：** 如果您使用其他DNS服务商的域名解析服务，请登录服务商系统修改网站域名的解析记录。

完成以下操作，将DNS解析到CDN。

1.  登录[阿里云云解析DNS控制台](https://dns.console.aliyun.com)。

2.  在**域名解析**页面，找到目标域名，单击**操作**列下的**解析设置**。

3.  在**解析设置**页面，找到要修改的解析记录，单击**操作**列下的**修改**。

4.  在**修改记录**对话框，选择**记录类型**为**CNAME**，并将**记录值**修改为步骤十五添加加速域名后分配的CNAME地址。详细信息，请参见[步骤十五：添加加速域名](#section_0se_ywl_xwa)。

    ![修改记录](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0707947061/p45868.png)

5.  单击**确定**。


## 步骤十七：访问测试

在接入地域（本方案为杭州、上海或深圳）下，使用Windows电脑测试全球加速联动CDN、DDoS高防（新BGP）、Web应用防火墙、全局流量管理后的防护和加速效果。

1.  在浏览器中使用Web服务域名（本方案为大陆域名www.example.com）访问美国（硅谷）地域部署的Web服务。

    经测试，可以通过大陆域名www.example.com访问美国（硅谷）地域部署的Web服务。

    ![访问测试](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4405588951/p96014.png)

2.  执行`nslookup <全局流量管理的CNAME接入域名>`查看解析结果。

    -   主服务器组（本方案为美国硅谷服务器1和服务器2）正常运行时：解析结果为美国硅谷服务器1或服务器2的IP。
    -   主服务器组（本方案为美国硅谷服务器1和服务器2）异常时：解析结果为美国硅谷服务器3或服务器4的IP。
3.  执行以下命令，查看数据包延迟情况。

    `curl -o /dev/null -s -w "time_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n" "http[s]://<Web服务域名>[:<端口>]"`

    其中：

    -   time\_connect：连接时间，从开始到建立TCP连接完成所用的时间。
    -   time\_starttransfer：开始传输时间。在客户端发出请求后，到后端服务器响应第一个字节所用的时间。
    -   time\_total：连接总时间。客户端发出请求后，到后端服务器响应会话所用的时间。
    经测试，使用全球加速后，降低了上海、杭州、深圳用户访问美国硅谷Web服务的延迟。

    ![加速前，访问延迟情况](../images/p76785.png "加速前的访问延迟情况")

    ![加速后，访问延迟情况](../images/p76786.png "加速后的访问延迟情况")

    **说明：** 全球加速联动CDN、DDoS高防（新BGP）、Web应用防火墙、全局流量管理后的防护和加速效果以您的实际业务测试为准。


