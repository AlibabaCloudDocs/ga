# 全球加速联动DDoS高防实现应用加速（旁路部署）

全球加速联动DDoS高防，依托阿里巴巴优质BGP带宽和全球传输网络，实现全球网络就近接入和跨地域部署，同时旁路部署DDoS高防，仅在特定场景下触发并切换启用DDoS高防，保证无DDoS攻击时日常业务的流畅体验以及发生DDoS攻击时达到更好的防护效果。

开始前，请确保满足以下条件：

-   您已经注册了阿里云账号。如未注册，请先完成[账号注册](https://account.alibabacloud.com/register/intl_register.htm)。
-   您的网站已经完成备案。

某互联网应用服务部署在美国（硅谷）地域的阿里云上，后端服务通过两个阿里云弹性公网IP对外提供互联网服务，转发端口为9000。终端用户主要集中在中国内地的上海、杭州和深圳地域。互联网应用服务偶尔会受到DDoS攻击，要求受到攻击时能启用DDoS防护。

![部署架构图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3519845951/p95972.png)

如上图，您可以创建全球加速实例，设置上海、杭州、深圳为加速区域，并旁路部署DDoS高防（新BGP）。部署完成后，在无攻击时，上海、杭州和深圳用户的访问请求通过加速IP就近从接入点进入阿里云加速网络 ，然后通过智能选择路由和自动网络调度，把客户端的网络访问请求送达至最佳终端节点；在受到攻击时，触发并切换启用DDoS高防，清洗过滤后再通过就近的接入点进入阿里云加速网络。

## 部署流程

![部署流程](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4519845951/p95886.png)

## 步骤一：创建全球加速实例

全球加速实例是一个运行的全球加速服务。

完成以下操作，创建全球加速实例。

1.  登录[全球加速管理控制台](https://ga.console.aliyun.com/list)。

2.  在**实例列表**页面，单击**创建加速实例**。

3.  在购买页面，根据以下信息配置全球加速实例，然后单击**立即购买**。

    1.  选择购买全球加速实例的规格。本方案选择**中型Ⅰ**。

        全球加速支持小型Ⅰ、小型Ⅱ、小型Ⅲ、中型Ⅰ、中型Ⅱ、中型Ⅲ六种规格，每种规格提供的加速服务如下表所示。

        |规格|加速地域个数|最大带宽处理能力|最大并发连接数|
        |--|------|--------|-------|
        |小型Ⅰ|1|20 Mbps|5000|
        |小型Ⅱ|2|40 Mbps|10000|
        |小型Ⅲ|3|60 Mbps|15000|
        |中型Ⅰ|5|100 Mbps|25000|
        |中型Ⅱ|8|160 Mbps|40000|
        |中型Ⅲ|10|200 Mbps|50000|

    2.  选择购买全球加速实例的时长。


## 步骤二：购买并绑定基础带宽包

基础带宽包提供了覆盖全球的公网接入带宽和阿里云内网传输带宽。实现全球加速您需要购买基础带宽包并将基础带宽包绑定到全球加速实例。

完成以下操作，购买并绑定基础带宽包。

1.  在**实例列表**页面，单击**购买基础带宽包**。

2.  在购买页面，配置基础带宽包，然后单击**立即购买**完成支付。

    1.  **带宽类型**：选择购买基础带宽包的带宽类型。本方案选择**标准加速带宽**。

        基础带宽包支持标准加速带宽、增强加速带宽和精品加速带宽三种带宽类型。带宽类型不同，加速类型、加速后端服务和加速范围也不同，如下表所示。

        |带宽类型|加速类型|加速后端服务|加速范围|
        |----|----|------|----|
        |标准加速带宽|阿里云上应用加速|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP

**说明：** 不支持加速经典网络类型的ECS实例和经典网络类型的SLB实例。

|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |增强加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |精品加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速全球区域（中国内地到海外区域间的加速通过中国香港加速点上车），选配跨域加速包后会进一步优化中国内地-海外间的网络加速效果|

        **说明：** 目前，将云服务器和负载均衡作为终端节点的功能白名单开放。如需使用，请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

    2.  **带宽峰值**：选择购买基础带宽包的带宽峰值。本方案选择**10Mb**。

    3.  **购买时长**：选择购买基础带宽包的时长。

3.  返回**实例列表**页面，单击已创建的全球加速实例ID。

4.  单击**带宽包管理**页签。

5.  在**基础带宽包**区域，找到目标基础带宽包，单击**操作**列下的**绑定**。

    ![绑定](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3405588951/p95529.png)

    绑定成功后，基础带宽包的状态变成**可用**。


## 步骤三：添加加速区域

在购买基础带宽包后，您便可以添加加速区域，指定访问后端服务的用户的所在地域并分配加速带宽。

完成以下操作，添加加速区域。

1.  在**实例列表**页面，单击步骤一中创建的全球加速实例ID。

2.  在实例详情页，单击**加速区域**页签，然后单击**添加加速区域**。

3.  在**添加加速区域**对话框，配置加速区域和接入区域，然后单击**确定**。

    1.  **加速区域**：选择需要进行访问加速的区域。本方案选择**华东**。

    2.  **地域**：选择访问加速服务用户的所属地域。本方案选择**杭州**。

    3.  **带宽**：选择加速服务的地域带宽。本方案选择**2**Mbps。

    4.  单击**+添加**，选择上海为加速地域，并为上海地域分配2Mbps带宽。

4.  重复上述步骤，添加华南区域的深圳地域为加速地域，并为深圳地域分配2Mbps带宽。


加速区域添加成功后，全球加速会为每个加速区域中的地域分配一个加速IP，用来加速用户访问。

![添加加速区域](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3405588951/p95535.png)

## 步骤四：创建监听

监听负责检查连接请求。系统会根据您指定的端口和协议转发来自客户端的入站连接。

完成以下操作，为全球加速实例创建监听。

1.  在**实例列表**页面，单击步骤一中创建的全球加速实例ID。

2.  在实例详情页，单击**监听**页签，然后单击**添加监听**。

3.  在**监听&协议**页面，配置监听。

    1.  **监听名称**：输入监听的名称。 名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短横线（-）。

    2.  **协议**：选择监听的协议类型。本方案选择**TCP**。

    3.  **端口**：指定用来接收请求并向终端节点进行转发的监听端口，端口取值范围：1~65499。本方案输入**9000**。

    4.  **客户端亲和性**：选择是否保持客户端亲和性。保持客户端亲和性，即客户端访问有状态的应用程序时，可以将来自同一客户端的所有请求都定向到同一终端节点。本方案选择**源IP**。

    ![监听](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4405588951/p95540.png)

4.  单击**下一步**配置终端节点组。


## 步骤五：设置终端节点组

每个监听都关联一个终端节点组，通过指定要分发流量的地域，将终端节点组与监听关联。关联后，全球加速会将流量分配到与监听关联的终端节点组内的最佳终端节点。

完成以下操作，设置终端节点组。

1.  在**节点组名称**区域输入节点组名称。

2.  选择终端节点组所属的地域，即请求要访问的目标服务器的所属地域。

    本方案选择**美国硅谷**。

3.  选择后端服务部署在阿里云还是非阿里云。本方案选择**阿里云**。

4.  选择开启或关闭保持客户端源IP。开启后，后端服务器可以通过该功能获取客户端源IP。本方案选择关闭保持客户端源IP。

    **说明：** 目前，保持客户端源IP功能白名单开放，如需使用请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

5.  配置终端节点。

    1.  **后端服务类型**：选择**阿里云弹性IP**。

    2.  **后端服务**：选择作为后端服务的EIP。

    3.  **权重**：输入终端节点的权重，权重取值范围：0~255。全球加速根据您配置的权重按比例将流量路由到终端节点。

        **说明：** 如果某个终端节点的权重设置为0，全球加速将终止向该终端节点分发流量，请您谨慎操作。

    4.  单击**+添加节点**添加另一个美国硅谷服务器作为终端节点，并配置权重。

    ![终端节点组](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4405588951/p95543.png)

6.  单击**下一步**查看监听和终端节点组配置，确认无误后，再单击**下一步**。


## 步骤六：购买并绑定跨域加速带宽包

跨域加速带宽包可以优化中国内地与海外区域间的网络加速。

完成以下操作，购买跨域加速带宽包并将跨域加速带宽包绑定到全球加速实例。

1.  在**实例列表**页面，单击**购买跨域加速带宽包**。

2.  在购买页面，配置跨域加速带宽包，然后单击**立即购买**完成支付。

    1.  **区域-A**：选择要互通的区域。本方案选择**中国内地**。

    2.  **区域-B**：选择要互通的区域。

        -   **全球**：客户端的访问请求根据客户端所属的加速地域自动选择全球最优出口。
        -   **香港**：客户端的访问请求统一从香港出口。
        本方案选择**全球**。

    3.  **计费方式**：选择跨域加速带宽包的计费方式。 目前，仅支持**按固定带宽计费**。

    4.  **带宽值**：选择跨域加速带宽包的带宽值。

        建议您购买的跨域加速带宽包的带宽值与基础带宽包的带宽值相同。本方案选择**10Mb**。

    5.  **购买时长**：选择购买时长。

3.  返回**实例列表**页面，找到目标全球加速实例，单击实例ID链接。

4.  单击**带宽包管理**页签。

5.  在**跨域加速带宽包**区域，找到目标跨域加速带宽包，单击**操作**列下的**绑定**。

    ![绑定](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4405588951/p95548.png)

    绑定成功后，跨域加速带宽包的状态变成**可用**。


## 步骤七：开通DDoS高防（新BGP）实例

DDoS高防（新BGP）拥有中国内地最大的BGP带宽资源，最高防护带宽达到1.5T，可以应对超大流量攻击。

完成以下操作，开通DDoS高防（新BGP）实例。

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在**实例列表**页面，单击**新购实例**。

3.  在购买页面，完成DDoS高防（新BGP）实例的购买配置。

    1.  **防护套餐**：默认为**专业版**，且不支持修改。

    2.  **保底防护带宽**：选择DDoS高防（新BGP）实例的保底防护带宽。本方案选择**30Gb**。

    3.  **弹性防护带宽**：选择DDoS高防（新BGP）实例的最大弹性防护带宽，对于超出保底防护带宽的攻击进行弹性防护。选方案选择**300Gb**。

    4.  **资源组**：选择DDoS高防（新BGP）实例所属的资源组。

    5.  **业务带宽**：选择DDoS高防（新BGP）实例的业务带宽，业务带宽即在无攻击状态下本实例最大可容纳的正常业务流量。本方案选择**100Mbps**。

    6.  **功能套餐**：选择功能套餐，支持**标准功能**和**增强功能**。本方案选择**增强功能**。

        关于标准功能和增强功能的差异，请参见[DDoS高防（新BGP&国际）功能套餐](/intl.zh-CN/产品计费/DDoS高防（新BGP&国际）功能套餐.md)。

    7.  **防护域名数**：选择支持接入防护的HTTP/HTTPS域名数量。本方案选择**50**。

        关于防护域名数的详细说明，请参见[防护域名数]()。

    8.  **业务QPS**：选择业务QPS，业务QPS是无攻击状态下本实例最大可容纳HTTP/HTTPS的并发请求速率。本方案选择**3000**。

    9.  **防护端口数**：选择支持的最大转发端口数量，即通过TCP/UDP协议转发支持的最大条目数。本方案选择**50**。

    10. **购买数量**：选择购买当前配置的实例的数量。

    11. **购买时长**：选择要购买实例的有效期。

4.  单击**立即购买**并完成支付。


## 步骤八：添加网站

网站配置定义了接入DDoS高防的网站业务的流量转发信息。

完成以下操作，在DDoS高防中添加要防护的网站信息。

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在顶部状态栏，选择服务所在地域。本方案选择**中国内地**。

3.  在左侧导航栏，单击**接入管理** \> **域名接入**。

4.  在**域名接入**页面，单击**添加网站**。

5.  在**添加网站**页面，填写网站信息。

    1.  **功能套餐**：选择要关联的DDoS高防实例的功能套餐规格。本方案选择**增强功能**。

    2.  **实例**：选中要关联的DDoS高防实例。一个网站域名最多支持关联八个DDoS高防实例，且不支持关联不同功能套餐的实例。

    3.  **网站**：输入要防护的网站域名。 本方案输入**www.example.com**。

    4.  **协议类型**：选择网站支持的协议类型。本方案保持默认选择的**HTTP**和**HTTPS**。

    5.  **启用HTTP2**：域名关联增强功能的高防实例时，选择是否开启HTTP2。开启后协议版本为HTTP2.0。

    6.  **服务器地址**：选择源站地址类型，并指定源站服务器地址。本方案选择**源站IP**，然后输入全球加速实例分配给上海、杭州、深圳地域的加速IP。

    7.  **服务器端口**：根据选择的协议类型指定服务器端口。 本方案指定端口为**9000**。

6.  单击**添加**。


## 步骤九：配置流量调度器

您可以通过DDoS高防流量调度器配置DDoS高防与云资源间的联动规则，仅在特定场景下触发并切换启用DDoS高防，保证无DDoS攻击时日常业务的流畅体验以及发生DDoS攻击时达到更好的防护效果。

完成以下操作，配置流量调度器。

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在顶部状态栏处，选择服务所在地域。本方案选择**中国内地**。

3.  在左侧导航栏，单击**接入管理**\> **流量调度器**。

4.  在**通用联动**页签下，单击**添加规则**。

5.  在**添加规则**对话框，完成联动规则配置，然后单击**下一步**。

    1.  **联动场景**：选择规则的联动场景。本方案选择**云产品联动**。

    2.  **规则名**：输入规则名称。

        规则名由英文字母、数字和下横线（\_）组成，不超过128个字符。

    3.  **DDoS高防IP**：选择要联动的高防实例。

    4.  **云资源**：选择云资源所在地域，然后输入云资源IP地址。

        单击**添加云资源IP**，可以添加多个云资源。最多支持添加20个IP。

        本方案选择华东1、华东2、华南1，然后分别输入步骤三中添加加速区域后全球加速实例分配给杭州、上海、深圳地域的加速IP。

    5.  **回切时间**：发生联动后，允许触发回切流程的等待时间。

        考虑到黑洞解除的等待时间以及避免频繁触发联动切换，回切时间的最小值为30分钟。本方案设置为60分钟。

6.  单击**完成**。

    成功添加规则后，流量调度器为新建规则分配一个CNAME地址。

    ![流量调度器](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5496958951/p95809.png)


## 步骤十：将DNS解析到流量调度器

使用流量调度器添加调度规则后，您必须更新规则对应域名的DNS解析CNAME记录，将网站业务流量切换至流量调度器，使规则生效。

**说明：** 如果您使用其他DNS服务商的域名解析服务，请登录服务商系统修改网站域名的解析记录。

完成以下操作，将DNS解析到流量调度器。

1.  登录[阿里云云解析DNS控制台](https://dns.console.aliyun.com)。

2.  在**域名解析**页面，找到目标域名，单击**操作**列下的**解析设置**。

3.  在**解析设置**页面，找到要修改的解析记录，单击**操作**列下的**修改**。

4.  在**修改记录**对话框，选择**记录类型**为**CNAME**，并将**记录值**修改为步骤九中配置流量调度器后为新建规则分配的CNAME地址。

    ![修改记录](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0707947061/p45868.png)

5.  单击**确定**。


## 步骤十一：访问测试

完成以下操作，测试全球加速和DDoS高防（新BGP）旁路部署时的防护和加速效果。

1.  在接入地域（本方案为杭州、上海或深圳）的电脑中打开浏览器。

2.  使用流量调度器分配的CNAME地址访问美国（硅谷）地域部署的互联网应用服务。

    经测试，可以通过流量调度器分配的CNAME地址访问美国（硅谷）地域部署的互联网应用服务。

    ![访问测试](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4405588951/p96014.png)

3.  执行`dig <流量调度器分配的CNAME地址>`查看解析结果。

    -   源站未被攻击时：解析结果为配置的全球加速的IP。
    -   源站被攻击时：解析结果为DDoS高防（新BGP）IP。

