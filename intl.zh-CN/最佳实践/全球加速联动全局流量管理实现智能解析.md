# 全球加速联动全局流量管理实现智能解析

全球加速依托阿里巴巴优质BGP带宽和全球传输网络，通过联动全局流量管理（GTM），可以为不同地域的客户端智能返回不同的加速IP，降低解析时延，提升Web服务访问速度。

开始前，请确保满足以下条件：

-   您已经注册了阿里云账号。如未注册，请先完成[账号注册](https://account.alibabacloud.com/register/intl_register.htm)。
-   您使用的DNS解析服务为非阿里云云解析DNS。

    如果您使用的是阿里云云解析DNS，您可以通过全球加速联动云解析DNS实现智能解析。详细信息，请参见[全球加速联动云解析DNS实现智能解析](/intl.zh-CN/最佳实践/全球加速联动云解析DNS实现智能解析.md)。

-   您的网站已经完成备案。

本文以下图场景为例。某Web服务部署在美国（硅谷）地域的阿里云上，后端服务通过阿里云弹性公网IP对外提供Web服务，转发端口为TCP 80端口，客户端分布在全球各地。Web服务通过传统DNS解析，不判断客户端的来源，随机选择其中一个IP地址返回给客户端，降低了解析效率，导致客户端访问Web服务速度慢。

您可以创建全球加速实例，设置上海、北京为加速区域，并联动全局流量管理实现智能DNS解析。配置成功后，智能DNS解析会判断客户端的来源，为不同地域的客户端智能返回不同的加速IP，降低解析时延，提升Web服务访问速度。

其中，

-   华东区域客户端访问Web服务会智能解析到全球加速上海加速IP。
-   华东以外的其他中国内地区域客户端访问Web服务会智能解析到全球加速北京加速IP。
-   境外区域客户端访问Web服务会直接走境外线路到美国（硅谷）源站IP。

![场景架构图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4977058951/p134114.png)

## 配置步骤

![配置步骤](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4977058951/p134232.png)

## 步骤一：填写加速业务

您可以在全球加速控制台填写自己的加速业务，系统会根据您的加速业务智能推荐需要购买的全球加速实例、基础带宽包和跨域加速带宽包。

完成以下操作，填写加速业务。

1.  登录[全球加速管理控制台](https://ga.console.aliyun.com/list)。

2.  在**实例列表**页面，单击右上角的**购买向导**。

    **说明：** 如果您是首次使用全球加速服务，请忽略该步骤。

    ![购买向导](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8472029951/p103054.png)

3.  在**智能推荐产品方案，选择以下与您业务相关的选项**区域，根据以下信息填写加速业务。

    -   **您需要加速的地域**：选择需要进行访问加速的地域。本示例选择**上海**和**北京**。
    -   **服务所在地域**：选择目标服务器所在的地域。本示例选择**美国（硅谷）**。
    -   **是否有ICP备案**：如果您的加速服务是Web服务，请选择是否有ICP备案。如果加速服务不是Web服务，请选择**无备案**。本示例选择**有备案**。

        **说明：** 所有对中国内地（大陆）提供服务的网站都必须先进行ICP备案，才可开通服务。详细信息，请参见[什么是备案]()。

    -   **服务端部署在**：选择后端服务部署在阿里云还是非阿里云。本示例选择**阿里云**。
    -   **峰值带宽的范围**：输入业务高峰期需要的带宽用量，单位是Mbps。本示例输入**10**。
    -   **最大并发连接数**：最大并发连接数定义了一个全球加速实例能够承载的最大连接数量。当实例上的连接超过规格定义的最大连接数时，新建连接请求将被丢弃。本示例选择**5千**。
4.  单击**点击生成方案**。

    生成方案后，您可以查看系统根据您的加速业务智能推荐的加速方案。

    ![智能推荐方案](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8267958951/p129367.png)


## 步骤二：组合购买实例

您可以根据系统推荐的加速方案，组合购买加速业务所需要的加速实例、基础带宽包和跨域加速带宽包。

完成以下操作，组合购买实例。

1.  单击**去组合购买**。

    ![组合购买入口](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8267958951/p103007.png)

2.  在购买页面，根据以下信息购买加速业务所需要的实例。

    -   **订购时长**：选择实例的订购时长。

        **说明：** 该订购时长是组合购的所有实例的订购时长。例如，您选择订购时长为1年，即全球加速实例、基础带宽包和跨域加速带宽包的订购时长都为1年。

    -   **规格**：选择购买全球加速实例的规格。 本示例选择**小型Ⅱ**。

        全球加速支持小型Ⅰ、小型Ⅱ、小型Ⅲ、中型Ⅰ、中型Ⅱ、中型Ⅲ六种规格，每种规格提供的加速服务如下表所示。

        |规格|加速地域个数|最大带宽处理能力|最大并发连接数|
        |--|------|--------|-------|
        |小型Ⅰ|1|20 Mbps|5000|
        |小型Ⅱ|2|40 Mbps|10000|
        |小型Ⅲ|3|60 Mbps|15000|
        |中型Ⅰ|5|100 Mbps|25000|
        |中型Ⅱ|8|160 Mbps|40000|
        |中型Ⅲ|10|200 Mbps|50000|

    -   **购买数量**：输入要购买的全球加速实例的数量。本示例输入**1**。
    -   **带宽类型**：选择购买基础带宽包的带宽类型。本示例选择**标准加速带宽**。

        基础带宽包支持标准加速带宽、增强加速带宽和精品加速带宽三种带宽类型。带宽类型不同，加速类型、加速后端服务和加速范围也不同，如下表所示。

        |带宽类型|加速类型|加速后端服务|加速范围|
        |----|----|------|----|
        |标准加速带宽|阿里云上应用加速|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP

**说明：** 不支持加速经典网络类型的ECS实例和经典网络类型的SLB实例。

|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |增强加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |精品加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速全球区域（中国内地到海外区域间的加速通过中国香港加速点上车），选配跨域加速包后会进一步优化中国内地-海外间的网络加速效果|

        **说明：** 目前，将云服务器和负载均衡作为终端节点的功能白名单开放。如需使用，请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

    -   **带宽峰值**：选择购买基础带宽包的带宽峰值。本示例选择**10Mb**。
    -   **带宽值**：选择购买跨域加速带宽包的带宽峰值。本示例选择**10Mb**。
3.  单击**立即购买**并完成支付。


购买完成后，基础带宽包和跨域加速带宽包会自动绑定到全球加速实例上。

![带宽包绑定实例](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8267958951/p129376.png)

## 步骤三：添加加速区域

购买加速业务所需要的实例后，您便可以添加加速区域，指定访问后端服务的用户的所在地域并分配加速带宽。

完成以下操作，添加加速区域。

1.  在**实例列表**页面，找到步骤二购买的全球加速实例，单击其实例ID。

2.  在实例详情页，单击**加速区域**页签，然后单击**添加加速区域**。

3.  在**添加加速区域**对话框，根据以下信息配置加速区域，然后单击**确定**。

    -   **加速区域**：选择需要进行访问加速的区域。本示例选择**华北**。
    -   **地域**：选择访问加速服务用户的所属地域。本示例选择**北京**。
    -   **带宽**：选择加速服务的地域带宽。本示例输入**5** Mbps。
4.  重复上述步骤，添加**华东**区域的**上海**地域为加速地域，并分配**5** Mbps带宽。


加速区域添加成功后，全球加速会为每个接入地域分配一个加速IP，用来加速用户访问。

![添加加速区域](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8267958951/p129384.png)

## 步骤四：添加监听

监听负责检查连接请求。系统会根据您指定的端口和协议转发来自客户端的入站连接。

完成以下操作，为全球加速实例添加监听。

1.  在实例详情页，单击**监听**页签，然后单击**添加监听**。

2.  在**监听&协议**页面，根据以下信息配置监听。

    -   **监听名称**：输入监听的名称。 名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短横线（-）。
    -   **协议**：选择监听的协议类型。本示例选择**TCP**。
    -   **端口**：指定用来接收请求并向终端节点进行转发的监听端口，端口取值范围：1~65499。本示例输入**80**。
    -   **客户端亲和性**：选择是否保持客户端亲和性。保持客户端亲和性，即客户端访问有状态的应用程序时，可以将来自同一客户端的所有请求都定向到同一终端节点。本示例选择**源IP**。
    ![监听](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7796363161/p84395.png)

3.  单击**下一步**。


## 步骤五：设置终端节点组

每个监听都关联一个终端节点组，通过指定要分发流量的地域，将终端节点组与监听关联。关联后，全球加速会将流量分配到与监听关联的终端节点组内的最佳终端节点。

完成以下操作，设置终端节点组。

1.  在**终端节点组**页面，根据以下信息配置终端节点组。

    -   **节点组名称**：输入节点组名称。名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短横线（-）。
    -   **地域**：选择终端节点组所属的地域，即请求要访问的目标服务器的所属地域。本示例选择**美国（硅谷）**。
    -   **后端服务部署在**：选择后端服务部署在阿里云还是非阿里云。本示例选择**阿里云**。
    -   **保持客户端源IP**：选择开启或关闭保持客户端源IP。开启后，后端服务器可以通过该功能获取客户端源IP。本示例选择关闭保持客户端源IP。

        **说明：** 目前，保持客户端源IP功能白名单开放，如需使用请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

    -   **终端节点**：配置终端节点。
        -   **后端服务类型**：选择**阿里云弹性IP**。
        -   **后端服务**：选择要加速的后端服务的弹性IP。
        -   **权重**：输入终端节点的权重，权重取值范围：0~255。全球加速根据您配置的权重按比例将流量路由到终端节点。

            **说明：** 如果某个终端节点的权重设置为0，全球加速将终止向该终端节点分发流量，请您谨慎操作。

    ![配置终端节点组](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8472029951/p129395.png)

2.  单击**下一步**查看监听和终端节点配置，确认无误后，再单击**下一步**。


## 步骤六：创建全局流量管理实例

全局流量管理是一种流量管理服务，可以帮助您精细化管理客户端的访问流量。

完成以下操作，创建全局流量管理实例。

1.  登录[阿里云云解析DNS控制台](https://dns.console.aliyun.com)。

2.  在左侧导航栏，单击**全局流量管理**。

3.  在**全局流量管理**页面，单击**创建实例**。

4.  在购买页面，根据以下信息配置全局流量管理实例。

    1.  **套餐版本**：默认为**标准版**，且不支持修改。

        标准版套餐说明如下：

        -   支持应用服务IP地址健康检查。
        -   支持DNS按照区域进行智能解析。
        -   支持配置DNS故障容灾策略。
        -   支持配置流量均衡策略。
    2.  **购买数量**：选择购买实例的数量。

    3.  **购买时长**：选择购买实例的时长。

5.  单击**立即购买**完成支付。


## 步骤七：配置地址池

一个全局流量管理实例，可以配置多个地址池，便于实现不同地区的客户端访问不同的地址池，并达到就近接入的效果。

完成以下操作，为全局流量管理配置地址池。

1.  在左侧导航栏，单击**全局流量管理**。

2.  在**全局流量管理**页面，找到步骤六创建的全局流量管理实例，单击**操作**列下的**配置**。

3.  在**选择配置方法**对话框，选择**高级配置**。

4.  在**配置管理**页面，单击**地址池配置**页签，然后单击**新增地址池**。

5.  在**新增地址池**对话框，根据以下信息配置地址池，然后单击**确认**。

    -   **地址池名称**：输入地址池的名称。

        本示例输入**北京加速IP**。

    -   **地址池类型**：选择地址池的类型。

        目前，支持**IP**和**域名**两种类型。本示例选择**IP**。

    -   **最小可用地址数量**：地址池中至少要包含的健康IP地址的数量。

        一个地址池内可能会存在多个IP地址，在通过健康检查对IP地址监控时，会实时统计地址池内健康IP地址的数量，并自动隔离故障IP。如果地址池内，健康IP地址的数量小于您设置的最小可用地址数量，系统会自动将地址池设置为不可用，同时访问策略会根据地址池的可用性状态自动选择是否切换至备用地址池。本示例输入**1**。

    -   **地址**：输入全球加速为北京地域分配的加速IP。详细信息，请参见[步骤三：添加加速区域](#section_rb1_2l8_cuz)。
    -   **模式**：选择地址工作模式。

        地址工作模式包含三种类型：

        -   **智能返回**： 根据健康检查状态，对IP地址进行动态选择，即IP地址健康检查正常时，DNS解析向客户端返回IP地址；IP地址异常时，系统则会将异常的IP地址暂时删除。
        -   **永远在线**： 系统判断该IP地址永远处于正常状态，DNS解析始终向客户端返回该IP地址。
        -   **永远离线**： 系统判断该IP地址永远处于异常状态，DNS解析不会向客户端返回该IP地址。
        本示例选择**智能返回**。

6.  重复上述步骤，分别添加上海加速IP和美国源站IP到地址池中。

    配置成功后，地址池如下表所示。

    |地址池名称|地址池类型|最小可用地址数量|地址|模式|
    |-----|-----|--------|--|--|
    |北京加速IP|IP|1|全球加速为北京地域分配的加速IP|智能返回|
    |上海加速IP|全球加速为上海地域分配的加速IP|
    |美国源站IP|美国源站服务器IP|


## 步骤八：配置访问策略

访问策略可以将不同来源的访问请求转发到不同的后端服务器，并可以根据实际业务需要设置备用后端服务器。

完成以下操作，为全局流量管理配置访问策略。

1.  单击**访问策略**页签，然后单击**新增访问策略**。

2.  在**新增访问策略**对话框，根据以下信息配置访问策略，然后单击**确认**。

    -   **策略名称**：输入访问策略的名称。本示例输入**全局访问策略**。
    -   **默认地址池**：选择默认地址池。

        默认地址池是业务正常情况下，全局流量管理将客户端访问流量转发到的后端服务器地址池。本示例选择步骤七配置的**北京加速IP**地址池。详细信息，请参见[步骤七：配置地址池](#section_cek_2jg_xdo)。

    -   **备用地址池**：选择备用地址池。

        备用地址池是在默认地址池中的服务器因故障不可用时，全局流量管理将客户端访问流量切换到的后端服务器地址池。 本示例选择**无**。

    -   **解析请求来源**： 选择解析请求来源。

        选择解析请求来源后，该区域的客户端访问Web服务时会智能调度到所配置的后端服务器地址池。本示例选择**全局** \> **全局**。

3.  重复上述步骤，分别为华东客户端、华东以外的其他中国内地客户端、境外客户端添加访问策略。


配置成功后，访问策略如下表所示。

|策略名称|默认地址池|备用地址池|解析请求来源|
|----|-----|-----|------|
|全局访问策略|北京加速IP|无|**全局** \> **全局**|
|华东客户端访问策略|上海加速IP|**大陆地区** \> **华东**|
|境外客户端访问策略|美国源站服务器IP|**境外地区** \> **境外**|

## 步骤九：配置基础信息

配置访问策略后，您需要配置全局流量管理实例的基础信息，包括主域名信息、CNAME接入域名、负载均衡策略、全局TTL、报警通知组等相关信息。

完成以下操作，配置基础信息。

1.  单击**全局配置**页签，单击**修改**。

2.  在弹出的对话框中，根据以下信息配置基础信息，然后单击**确认**。

    -   **实例名称**：输入全局流量管理实例的名称。
    -   **主域名**：输入客户端访问的域名。本示例输入**www.example.com**。
    -   **CNAME接入域名**：选择接入域名的类型。本示例选择**系统分配接入域名**。
    -   **均衡策略**：选择全局流量管理的均衡策略。

        -   **负载均摊**：默认策略，是指当地址池内存在多个IP地址，由各个IP地址平均分配访问流量。
        -   **加权轮询**：如果Web服务的客户端用户分布在全国或世界范围内，可以根据IP地址的处理能力，选择加权轮询策略。加权轮询可以实现将解析流量按照权重进行分配，在DNS查询请求时，IP地址按照预先设置的权重进行返回。
        本示例选择**负载均摊**。

    -   **全局TTL**：域名解析对应IP地址的生效时间。本示例选择**1分钟**。

        全局流量管理是以域名形式对外提供流量管理服务，全局TTL即域名对应IP地址信息在运营商DNS系统内的缓存生效时间，默认提供1分钟的TTL时间。如果使用自定义接入域名方式，全局TTL需要与自定义域名的云解析套餐支持的最小TTL保持一致。

    -   **报警通知组**：当业务出现异常时，用于接收通知消息的联系组。

        **说明：**

        -   如果您未配置报警通知组，请先前往云监控控制台设置。详细信息，请参见[创建报警联系人或报警联系组](/intl.zh-CN/报警服务/报警联系人/创建报警联系人或报警联系组.md)。
        -   如果您已经配置了报警通知组，但您使用子账号配置基础信息，请先使用主账号授权。授权成功后，子账号才能读取到报警通知组信息。

基本信息配置完成后，系统会自动分配一个CNAME接入域名用于解析要调度的后端服务IP。

![cname](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5496958951/p99619.png)

## 步骤十：配置DNS解析

您需要登录您的DNS服务商系统，将域名的DNS解析到全局流量管理分配的CNAME，使业务流量切换至全局流量管理实例。配置详情，请咨询您的DNS服务商。

## 步骤十一：访问测试

完成以下操作，测试全球加速联动全局流量管理后实现的智能解析效果。

1.  在华东区域、华东以外的其他中国内地区域、境外区域，打开电脑的cmd窗口。

2.  执行`nslookup <Web服务域名>`查看解析结果。

    经测试，解析结果如下：

    -   华东区域客户端访问Web服务会智能解析到全球加速上海加速IP。
    -   华东以外的其他中国内地区域客户端访问Web服务会智能解析到全球加速北京加速IP。
    -   境外区域客户端访问Web服务会直接走境外线路到美国（硅谷）源站IP。

