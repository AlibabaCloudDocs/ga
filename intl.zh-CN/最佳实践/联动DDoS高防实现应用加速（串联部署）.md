# 联动DDoS高防实现应用加速（串联部署）

全球加速联动DDoS高防，依托阿里云优质BGP带宽和全球传输网络，实现全球网络就近接入和跨地域部署，同时串联全球加速和DDoS高防，终端请求进入加速网络前先进行DDoS流量清洗，保护互联网应用服务持续可用，为全球移动互联网服务商提供一套高安全的跨地域加速方案。

开始前，请确保满足以下条件：

-   您已经注册了阿里云账号。如未注册，请先完成[账号注册](https://account.alibabacloud.com/register/intl_register.htm)。
-   您的网站已经完成备案。

某互联网应用服务部署在美国（硅谷）地域的阿里云上，后端服务通过两个阿里云弹性公网IP对外提供互联网服务，转发端口为TCP 9000端口。终端用户主要集中在中国内地的上海、杭州和深圳地域。互联网应用服务经常受到大规模的DDoS攻击，严重影响互联网应用服务的可持续性。

![部署结构图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5195616951/p95599.png)

如上图，您可以创建全球加速实例，设置上海、杭州、深圳为加速区域，并串联部署全球加速和DDoS高防（新BGP）。部署完成后，来自公网的访问流量都将优先经过高防机房，恶意攻击流量将在高防流量清洗中心进行清洗过滤，正常的访问流量通过端口协议转发的方式返回给源站服务器。其中上海、杭州和深圳用户的访问请求通过加速IP就近从接入点进入阿里云加速网络 ，然后通过智能选择路由和自动网络调度，把客户端的网络访问请求送至最佳终端节点，避开公网的拥堵，达到减少时延的效果。

## 部署流程

![部署流程](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5195616951/p95713.png)

## 步骤一：创建全球加速实例

1.  登录[全球加速管理控制台](https://ga.console.aliyun.com/list)。

2.  在**实例列表**页面，单击**创建加速实例**。

3.  在购买页面，根据以下信息配置全球加速实例，然后单击**立即购买**，并按照页面提示完成支付。

    1.  选择购买全球加速实例的规格。本方案选择**中型Ⅰ**。

        全球加速支持小型Ⅰ、小型Ⅱ、小型Ⅲ、中型Ⅰ、中型Ⅱ、中型Ⅲ六种规格，每种规格提供的加速服务如下表所示。

        |规格|加速地域个数|最大带宽处理能力|最大并发连接数|
        |--|------|--------|-------|
        |小型Ⅰ|1|20 Mbps|5000|
        |小型Ⅱ|2|40 Mbps|10000|
        |小型Ⅲ|3|60 Mbps|15000|
        |中型Ⅰ|5|100 Mbps|25000|
        |中型Ⅱ|8|160 Mbps|40000|
        |中型Ⅲ|10|200 Mbps|50000|

    2.  选择购买全球加速实例的时长。


## 步骤二：购买并绑定基础带宽包

基础带宽包提供了覆盖全球的公网接入带宽和阿里云内网传输带宽。实现全球加速您需要购买基础带宽包并将基础带宽包绑定到全球加速实例。

1.  在**实例列表**页面，单击**购买基础带宽包**。

2.  在购买页面，配置基础带宽包，然后单击**立即购买**完成支付。

    1.  **带宽类型**：选择购买基础带宽包的带宽类型。本方案选择**标准加速带宽**。

        基础带宽包支持标准加速带宽、增强加速带宽和精品加速带宽三种带宽类型。带宽类型不同，加速类型、加速后端服务和加速范围也不同，如下表所示。

        |带宽类型|加速类型|加速后端服务|加速范围|
        |----|----|------|----|
        |标准加速带宽|阿里云上应用加速|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP

**说明：** 不支持加速经典网络类型的ECS实例和经典网络类型的SLB实例。

|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输。|
        |增强加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输。|
        |精品加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速全球区域（中国内地到海外区域间的加速通过中国香港加速点接入），选配跨域加速包后可以优化中国内地-海外间的网络传输。|

        **说明：** 目前，将云服务器和负载均衡作为终端节点的功能白名单开放。如需使用，请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

    2.  **带宽峰值**：选择购买基础带宽包的带宽峰值。本方案选择**10Mb**。

    3.  **购买时长**：选择购买基础带宽包的时长。

3.  返回**实例列表**页面，单击已创建的全球加速实例ID。

4.  单击**带宽包管理**页签。

5.  在**基础带宽包**区域，找到目标基础带宽包，单击**操作**列下的**绑定**。

    ![绑定](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3405588951/p95529.png)

    绑定成功后，基础带宽包的状态变成**可用**。


## 步骤三：添加加速区域

在购买基础带宽包后，您便可以添加加速区域，指定访问后端服务的用户的所在地域并分配加速带宽。

1.  在**实例列表**页面，单击在[步骤一](#section_l1r_uk0_vfj)中创建的全球加速实例ID。

2.  在实例详情页，单击**加速区域**页签，然后单击**添加接入地域**。

3.  在**添加加速区域**对话框，配置加速地域和接入地域，然后单击**确定**。

    |参数|描述|
    |--|--|
    |**地域**|选择访问加速服务用户的所属地域。本方案选择**杭州**。|
    |**带宽**|选择加速服务的地域带宽。本方案选择**2**Mbps。|
    |**IP地址协议**|选择IP地址协议，支持IPv4接入或者IPv6接入，不支持IPv6和IPv4接入模式相互转换。生效后如需更改请先该删除加速区域，重新添加。|
    |**操作**|针对该加速区域可执行的操作。|
    |**添加**|单击**添加**，添加上海为加速地域，并为上海地域分配2Mbps带宽。|

4.  重复上述步骤，添加华南区域的深圳地域为加速地域，并为深圳地域分配2Mbps带宽。

    加速区域添加成功后，全球加速会为加速地域分配一个加速IP，用来加速用户访问。


## 步骤四：创建监听

监听负责检查连接请求。系统会根据您指定的端口和协议转发来自客户端的入站连接。

1.  在**实例列表**页面，单击[步骤一](#section_l1r_uk0_vfj)中创建的全球加速实例ID。

2.  默认进入实例详情页的**监听**页签，单击**添加监听**。

3.  在**配置监听和协议**的配置向导页面，配置监听。然后单击**下一步**。

    |参数|描述|
    |--|--|
    |**监听名称**|输入监听的名称。 名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短划线（-）。|
    |**协议**|选择监听的协议类型。本方案选择**TCP**。|
    |**端口**|指定用来接收请求并向终端节点进行转发的监听端口，端口取值范围：1~65499。本方案输入**9000**。|
    |**客户端亲和性**|选择是否保持客户端亲和性。保持客户端亲和性，即客户端访问有状态的应用程序时，可以将来自同一客户端的所有请求都定向到同一终端节点。本方案选择**源IP**。|

4.  在**配置终端节点**配置向导页面设置终端节点组，配置完成后单击**下一步**。

    1.  在**节点组名称**区域输入节点组名称。

    2.  选择终端节点组所属的地域，即请求要访问的目标服务器的所属地域。

        本方案选择**美国硅谷**。

    3.  选择后端服务部署在阿里云还是非阿里云。本方案选择**阿里云**。

    4.  选择开启或关闭保持客户端源IP。开启后，后端服务器可以通过该功能获取客户端源IP。本方案选择关闭保持客户端源IP。

    5.  配置终端节点。

        |参数|描述|
        |--|--|
        |**后端服务类型**|选择**阿里云公网IP**。|
        |**后端服务**|输入后端服务器提供服务的EIP。|
        |**权重**|输入终端节点的权重，权重取值范围：0～255。全球加速根据您配置的权重按比例将流量路由到终端节点。**说明：** 如果某个终端节点的权重设置为0，全球加速将终止向该终端节点分发流量，请您谨慎操作。 |
        |**+添加节点**|单击**+添加节点**，然后添加另一个美国硅谷服务器作为终端节点，并配置权重。|

5.  在**配置审核**页面查看监听和终端节点组配置，确认无误后，单击**提交**。


## 步骤五：购买并绑定跨域加速带宽包

跨域加速带宽包可以优化中国内地与海外区域间的网络加速。完成以下操作，购买跨域加速带宽包并将跨域加速带宽包绑定到全球加速实例。

1.  在**实例列表**页面，单击**购买跨域加速带宽包**。

2.  在购买页面，配置跨域加速带宽包，然后单击**立即购买**完成支付。

    1.  **区域-A**：选择要互通的区域。本方案选择**中国内地**。

    2.  **区域-B**：选择要互通的区域，默认选择**全球**。

        **全球**：客户端的访问请求根据客户端所属的加速地域自动选择全球最优出口。

    3.  **计费方式**：选择跨域加速带宽包的计费方式。 目前，仅支持**按固定带宽计费**。

    4.  **带宽值**：选择跨域加速带宽包的带宽值。

        建议您购买的跨域加速带宽包的带宽值与基础带宽包的带宽值相同。本方案选择**10Mb**。

    5.  **购买时长**：选择购买时长。

3.  返回**实例列表**页面，找到目标全球加速实例，单击实例ID链接。

4.  单击**带宽包管理**页签。

5.  在**跨域加速带宽包**区域，找到目标跨域加速带宽包，单击**操作**列下的**绑定**。

    ![绑定](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1222031261/p95548.png)

    绑定成功后，跨域加速带宽包的状态变成**可用**。


## 步骤六：开通DDoS高防（新BGP）实例

DDoS高防（新BGP）拥有中国内地最大的BGP带宽资源，最高防护带宽达到1.5T，可以应对超大流量攻击。

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在**实例管理**页面，单击**新购实例**。

3.  在购买页面，完成DDoS高防（新BGP）实例的购买配置。

    |参数|描述|
    |--|--|
    |**商品类型**|默认选择**DDoS高防（新BGP）**。|
    |**防护套餐**|默认为**专业版**。|
    |**保底防护带宽**|选择实例的保底防护带宽。 保底防护需要预付费后生效。保底防护带宽越大，实例配置费用越高。 |
    |**弹性防护带宽**|选择实例的弹性防护带宽。 弹性防护使用按量后付费的方式计费。弹性防护带宽决定实例的最高防护带宽。

    -   如果**弹性防护带宽**和**保底防护带宽**一样，则最高防护带宽为**保底防护带宽**且不会产生后付费。
    -   如果**弹性防护带宽**高于**保底防护带宽**，则超过**保底防护带宽**但不大于**弹性防护带宽**的攻击仍然可以进行有效防护，但会根据超出**保底防护带宽**部分的攻击峰值产生后付费账单。 |
    |**业务规模**|选择实例支持处理的正常业务的网络带宽。最小值：100~5000 Mbps。 请根据所有要接入当前实例防护的业务的整体规模估算需要的**业务带宽**，取入流量或出流量其中的较大值。更多信息，请参见[如何选择业务带宽？](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/开通DDoS高防（新BGP&国际）.md)。

**说明：** 如果您购买的实例业务带宽不够用，可能会丢包或者影响业务，在这种情况下请及时升级业务带宽。 |
    |**功能套餐**|选择实例的功能套餐类型。可选项：     -   **标准功能**
    -   **增强功能**
关于不同功能套餐的差异说明，请参见[DDoS高防（新BGP&国际）功能套餐](/intl.zh-CN/产品计费/DDoS高防（新BGP&国际）功能套餐.md)。 |
    |**防护域名数**|选择支持接入实例防护的域名配置的数量。支持以10个域名配置为单位增加或减少。可选范围：50~200。 域名配置中支持使用子域名、泛域名，且子域名、泛域名对应不同域名的数量不超过**防护域名数**/10。

例如，默认**防护域名数**为50，表示支持接入最多5个不同的域名对应的子域名、泛域名配置，且所有域名配置的总数不超过50个。

假设要接入防护的域名包括example1.com、example2.com，则支持使用上述域名的子域名（例如www.example1.com、abc.example2.com）、泛域名（\*.example1.com）作为域名接入配置。

如果需要接入的域名配置的总数超过50，或者域名配置对应的域名数量超过5个，建议您根据需要增加**防护域名数**规格。 |
    |**业务QPS**|选择无攻击状态下实例最大可处理的并发请求速率，包含使用HTTP协议和HTTPS协议的请求。可选范围：3000~100000。|
    |**防护端口数**|选择实例支持接入的端口转发配置的数量，包含使用TCP和UDP协议添加的端口转发配置。可选范围：50~400。|
    |**资源组**|选择实例隶属的资源组，默认使用**默认资源组**。 **说明：** 目前仅支持在旧版购买页面中配置。如果您需要将实例划分到**默认资源组**以外的资源组，请单击页面右上角的**回到旧版**并通过旧版购买页面中创建实例。 |
    |**购买数量**|选择要购买的实例的数量。|
    |**购买时长**|选择要购买的实例的有效期。 如果选中**到期自动续费**，则在实例到期前自动触发续费。

    -   按月购买时自动续费周期为一个月。
    -   按年购买时自动续费周期为一年。 |

4.  单击**立即购买**并完成支付。


## 步骤七：添加转发规则

端口配置是DDoS高防网络四层防护设置的入口，定义了DDoS高防实例的业务转发规则。

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在左侧导航栏，单击**接入管理** \> **端口接入**。

3.  在顶部状态栏，选择服务所在地域。

    本方案中流量经DDoS高防（新BGP）防护后转发给全球加速，所以选择**中国内地**。

4.  在**端口接入**页面，选择要操作的DDoS高防实例，然后单击**添加规则**。

5.  在**添加规则**对话框，根据您的实际业务完成规则配置，然后单击**完成**。

    1.  **转发协议**：选择转发协议类型。本方案选择**TCP**。

    2.  **转发端口**：输入DDoS高防实例使用的转发端口。本方案输入**9000**。

    3.  **源站端口**：输入源站使用的业务端口。本方案输入**9000**。

    4.  **源站IP**：输入源站IP。本方案输入步骤三中添加加速区域后全球加速实例分配给上海、杭州、深圳地域的加速IP。

    ![添加转发端口](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6195616951/p95892.png)


## 步骤八：访问测试

完成以下操作，测试全球加速和DDoS高防串联部署时的防护和加速效果。

1.  在接入地域（本方案为杭州、上海或深圳）的电脑中打开浏览器。

2.  输入DDoS高防IP和转发端口访问美国（硅谷）地域部署的互联网应用服务。

    经测试，可以通过DDoS高防IP和转发端口访问美国（硅谷）地域部署的互联网应用服务。

    ![访问测试](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6195616951/p95861.png)

3.  在接入地域（本方案为杭州、上海或深圳）的电脑中打开命令行窗口。

4.  执行以下命令，查看数据包延迟情况。

    `curl -o /dev/null -s -w "time_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n" "http[s]://<DDoS高防IP\>\[:<端口\>\]"`

    其中：

    -   time\_connect：连接时间，从开始到建立TCP连接完成所用的时间。
    -   time\_starttransfer：开始传输时间。在客户端发出请求后，到后端服务器响应第一个字节所用的时间。
    -   time\_total：连接总时间。客户端发出请求后，到后端服务器响应会话所用的时间。
    经测试，使用全球加速后，降低了上海、杭州、深圳用户访问美国硅谷应用服务的延迟。

    ![加速前，访问延迟情况](../images/p76785.png "加速前的访问延迟情况")

    ![加速后，访问延迟情况](../images/p76786.png "加速后的访问延迟情况")

    **说明：** 全球加速联动DDoS高防串联部署后的加速效果以您的实际业务测试为准。


