# 中国内地到海外区域间应用加速

本教程以加速区域在中国内地区域、服务区域在海外区域为例，介绍如何使用全球加速实现中国内地到海外区域间的应用加速。

本教程以下图的场景为例。某公司在美国硅谷有两台自建服务器，并在服务器上都部署了企业应用服务，服务器1性能弱只能接受20%的访问流量，服务器2性能强可以接受80%的访问流量。但因跨国公网不稳定，中国上海办公点的员工访问美国硅谷服务器上的企业应用经常出现延迟、抖动、丢包等问题。

您可以通过全球加速服务，实现上海办公点访问美国硅谷服务器的流量通过加速IP就近从上海接入点进入阿里云加速网络，然后通过智能路由把客户端的网络访问请求送达终端节点，并将20%的访问流量分发给服务器1，80%的访问流量分发给服务器2。

![中国内地到海外加速场景](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5642745951/p103082.png)

## 配置步骤

![配置步骤](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6642745951/p103130.png)

## 步骤一：填写加速业务

您可以在全球加速控制台填写自己的加速业务，系统会根据您的加速业务智能推荐需要购买的加速实例、基础带宽包和跨域加速带宽包。

完成以下操作，填写加速业务。

1.  登录[全球加速管理控制台](https://ga.console.aliyun.com/list)。

2.  在**实例列表**页面，单击右上角的**购买向导**。

    **说明：** 如果您是首次使用全球加速服务，请忽略该步骤。

    ![购买向导](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8472029951/p103054.png)

3.  在**智能推荐产品方案，选择以下与您业务相关的选项**区域，根据以下信息填写加速业务。

    -   **您需要加速的地域**：选择需要进行访问加速的地域。本教程选择**上海**。
    -   **服务所在地域**：选择目标服务器所在的地域。本教程选择**美国（硅谷）**。
    -   **是否有ICP备案**：如果您的加速服务是Web服务，请选择是否有ICP备案。如果加速服务不是Web服务，请选择**无备案**。本教程选择**有备案**。

        **说明：** 所有对中国内地（大陆）提供服务的网站都必须先进行ICP备案，才可开通服务。详细信息，请参见[什么是备案]()。

    -   **服务端部署在**：选择后端服务部署在阿里云还是非阿里云。本教程选择**非阿里云**。
    -   **峰值带宽的范围**：输入业务高峰期需要的带宽用量，单位是Mbps。本教程输入**10**。
    -   **最大并发连接数**：最大并发连接数定义了一个全球加速实例能够承载的最大连接数量。当实例上的连接超过规格定义的最大连接数时，新建连接请求将被丢弃。本教程选择**5千**。
4.  单击**点击生成方案**。

    生成方案后，您可以查看系统根据您的加速业务智能推荐的加速方案。

    ![智能推荐方案](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6642745951/p103124.png)


## 步骤二：组合购买实例

您可以根据系统推荐的加速方案，组合购买加速业务所需要的加速实例、基础带宽包和跨域加速带宽包。

完成以下操作，组合购买实例。

1.  单击**去组合购买**。

    ![组合购](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6642745951/p103126.png)

2.  在购买页面，根据以下信息购买加速业务所需要的实例。

    -   **订购时长**：选择实例的订购时长。

        **说明：** 该订购时长是组合购的所有实例的订购时长。例如，您选择订购时长为1年，即全球加速实例、基础带宽包和跨域加速带宽包的订购时长都为1年。

    -   **规格**：选择购买全球加速实例的规格。本教程选择**小型Ⅰ**。

        全球加速支持小型Ⅰ、小型Ⅱ、小型Ⅲ、中型Ⅰ、中型Ⅱ、中型Ⅲ六种规格，每种规格提供的加速服务如下表所示。

        |规格|加速地域个数|最大带宽处理能力|最大并发连接数|
        |--|------|--------|-------|
        |小型Ⅰ|1|20 Mbps|5000|
        |小型Ⅱ|2|40 Mbps|10000|
        |小型Ⅲ|3|60 Mbps|15000|
        |中型Ⅰ|5|100 Mbps|25000|
        |中型Ⅱ|8|160 Mbps|40000|
        |中型Ⅲ|10|200 Mbps|50000|

    -   **带宽类型**：选择购买基础带宽包的带宽类型。本教程选择**增强加速带宽**。

        基础带宽包支持标准加速带宽、增强加速带宽和精品加速带宽三种带宽类型。带宽类型不同，加速类型、加速后端服务和加速范围也不同，如下表所示。

        |带宽类型|加速类型|加速后端服务|加速范围|
        |----|----|------|----|
        |标准加速带宽|阿里云上应用加速|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP

**说明：** 不支持加速经典网络类型的ECS实例和经典网络类型的SLB实例。

|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |增强加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速中国内地区域，选配跨域加速包后可以优化中国内地-海外间的网络传输|
        |精品加速带宽|        -   阿里云上应用加速
        -   阿里云下应用加速
|        -   云服务器ECS
        -   负载均衡SLB
        -   阿里云公网IP
        -   自定义IP
        -   自定义域名
|默认加速全球区域（中国内地到海外区域间的加速通过中国香港加速点上车），选配跨域加速包后会进一步优化中国内地-海外间的网络加速效果|

        **说明：** 目前，将云服务器和负载均衡作为终端节点的功能白名单开放。如需使用，请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

    -   **带宽峰值**：选择购买基础带宽包的带宽峰值。本教程选择**10Mb**。
    -   **区域A**：选择要互通的区域。本教程选择**中国内地**。
    -   **区域B**：选择要互通的区域。本教程选择**全球**。
    -   **带宽值**：选择跨域加速带宽包的带宽值。

        建议您购买的跨域加速带宽包的带宽值与基础带宽包的带宽值相同。本教程选择**10Mb**。

3.  单击**立即购买**并完成支付。


购买完成后，基础带宽包和跨域加速带宽包会自动绑定到加速实例上，状态变更为**可用**。

![带宽包自动绑定](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6642745951/p103127.png)

## 步骤三：添加加速区域

购买加速业务所需要的实例后，您便可以添加加速区域，指定访问后端服务的用户的所在地域并分配加速带宽。

完成以下操作，添加华东区域为加速区域，并将华东区域中的上海地域添加为加速地域。

1.  登录[全球加速管理控制台](https://ga.console.aliyun.com/list)。

2.  在**实例列表**页面，找到目标全球加速实例，单击实例ID链接。

3.  在**加速区域**页签下，单击**添加加速区域**。

4.  在**添加加速区域**对话框，根据以下信息配置加速区域和接入区域。

    -   **加速区域**：选择需要进行访问加速的区域。本教程选择**华东**。
    -   **接入区域**：在已经选择的加速区域下，选择要接入的地域，并为该地域分配带宽。

        本教程选择**上海**地域，并为该地域分配**10Mbps**带宽。

5.  单击**确定**。


## 步骤四：添加监听

监听负责检查连接请求。系统会根据您指定的端口和协议转发来自客户端的入站连接。

完成以下操作，为全球加速实例添加监听。

1.  在实例详情页，单击**监听**页签，然后单击**添加监听**。

2.  在**监听&协议**向导下，根据以下信息，配置监听&协议。

    -   **监听名称**：输入监听的名称。

        名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短横线（-）。

    -   **协议**：选择监听的协议类型，支持以下协议。

        -   **TCP**：TCP协议，TCP协议具有以下特性。
            -   面向连接的协议，可靠性高。在正式收发数据前，必须和对方建立可靠的连接。
            -   基于源地址的会话保持。
            -   在网络层可直接看到来源地址。
            -   数据传输慢。
        -   **UDP**：UDP协议，UDP协议具有以下特性。
            -   面向非连接的协议，可靠性低。在数据发送前不与对方进行三次握手，直接进行数据包发送，不提供差错恢复和数据重传机制。
            -   数据传输快。
        本教程选择**TCP**。

    -   **端口**：用来接收请求并向终端节点进行转发的监听端口，端口取值范围：1~65535。

        本教程输入**80**。

    -   **客户端亲和性**：是否保持客户端亲和性。

        -   选择**源IP**时，保持客户端亲和性，即客户端访问有状态的应用程序时，可以将来自同一客户端的所有请求都定向到同一终端节点。
        -   选择**关闭**时，不保持客户端亲和性，即不能确保来自同一客户端的连接请求始终定向到同一终端节点。
        本教程选择**关闭**。

3.  单击**下一步**。


## 步骤五：设置终端节点组

每个监听都关联一个终端节点组，通过指定要分发流量的地域，将终端节点组与监听关联。关联后，全球加速会将流量分配到与监听关联的终端节点组内的最佳终端节点。

完成以下操作，设置终端节点组。

1.  在**设置终端节点组**向导下，根据以下信息配置终端节点组。

    -   **节点组名称**：输入终端节点组的名称。

        名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短横线（-）。

    -   **地域**：选择终端节点组所属的地域。本教程选择**美国（硅谷）**。
    -   **后端服务部署在**：选择后端服务部署地是阿里云还是非阿里云。本教程选择**非阿里云**。
    -   **保持客户端源IP**：选择开启或关闭保持客户端源IP。开启后，后端服务器可以通过该功能获取客户端源IP。本教程选择关闭保持客户端源IP。

        **说明：** 目前，保持客户端源IP功能白名单开放，如需使用请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.11182188.console-base-top.dworkorder.18ae4882n3v6ZW#/ticket/createIndex)。

    -   **终端节点**：终端节点是客户端请求访问的目标主机。您可以根据以下信息配置两个终端节点。

        将服务器1添加到终端节点：

        -   **后端服务类型**：支持选择自定义IP和自定义域名。本教程选择**自定义IP**。
        -   **后端服务**：本教程输入服务器1的公网IP地址。
        -   **权重**：输入终端节点权重，全球加速根据您配置的权重按比例将流量路由到终端节点。本教程输入**10**。
        将服务器2添加到终端节点：

        -   **后端服务类型**：本教程选择**自定义IP**。
        -   **后端服务**：本教程输入服务器2的公网IP地址。
        -   **权重**：输入终端节点权重，权重取值范围：0~255。全球加速根据您配置的权重按比例将流量路由到终端节点。本教程输入**40**。
    ![ip终端节点](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8465273161/p84404.png)

2.  单击**下一步**。

3.  在**配置审核**向导下，确认无误后，单击**下一步**。


## 步骤六：测试加速效果

完成以下操作，在上海办公点测试加速效果。

1.  打开上海办公点PC的cmd窗口。

2.  执行以下命令，查看数据包延迟情况。

    `curl -o /dev/null -s -w "time_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n" "http[s]://<终端节点IP>[:<端口>]"`

    其中：

    -   time\_connect：连接时间，从开始到建立TCP连接完成所用的时间。
    -   time\_starttransfer：开始传输时间。在客户端发出请求后，到后端服务器响应第一个字节所用的时间。
    -   time\_total：连接总时间。客户端发出请求后，到后端服务器响应会话所用的时间。
    经测试，使用全球加速后，降低了上海办公点访问美国硅谷服务器上应用服务的延迟。

    ![加速前，访问延迟情况](../images/p76785.png "加速前的访问延迟情况")

    ![加速后，访问延迟情况](../images/p76786.png "加速后的访问延迟情况")

    **说明：** 如果全球加速配置的监听协议是UDP协议，您可以通过UDPing测试全球加速的加速效果。详细信息，请参见[测试UDP监听协议的加速效果](/intl.zh-CN/监控与运维/测试UDP监听协议的加速效果.md)。


