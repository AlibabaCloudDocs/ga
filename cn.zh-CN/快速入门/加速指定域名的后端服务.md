# 加速指定域名的后端服务

本文指导您使用全球加速服务加速指定域名的后端服务，提升用户的访问速度和体验。

本文以下图的场景为例。某公司的总部在美国，Web服务部署在总部的自建服务器上。Web服务通过域名www.example.com对外提供服务，转发端口为80。因跨国网络不稳定，中国香港办公点的员工访问美国服务器上的Web服务经常出现延迟、抖动、丢包等问题。

![加速指定域名的后端服务器](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6796363161/p103042.png)

您可以配置全球加速，实现中国香港办公点访问美国服务器的流量通过加速IP就近从中国香港接入点进入阿里云加速网络，然后通过智能路由把客户端的网络访问请求送达终端节点，提升中国香港办公点用户的访问速度和体验。

## 配置步骤

![加速指定域名的后端服务配置步骤](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5642745951/p103045.png)

## 步骤一：填写加速业务

您可以在全球加速控制台填写自己的加速业务，系统会根据您的加速业务智能推荐需要购买的加速实例和基础带宽包。

1.  登录[全球加速管理控制台](https://ga.console.aliyun.com/list)。

2.  在**实例列表**页面，单击右上角的**购买向导**。

    **说明：** 如果您是首次使用全球加速服务，请忽略该步骤。

    ![购买向导](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8472029951/p103054.png)

3.  在**智能推荐产品方案，选择以下与您业务相关的选项**区域，根据以下信息填写加速业务。

    -   **您需要加速的地域**：选择需要进行访问加速的地域。本文选择**中国（香港）**。
    -   **服务所在地域**：选择目标服务器所在的地域。本文选择**美国（硅谷）**。
    -   **是否有ICP备案**：如果您的加速服务是Web服务，请选择**有备案**。如果加速服务不是Web服务，请选择**无备案**。本文选择**无备案**。

        **说明：** 所有对中国内地（大陆）提供服务的网站都必须先进行ICP备案，才可开通服务。更多信息，请参见[什么是ICP备案]()。

    -   **服务端部署在**：选择后端服务部署在阿里云还是非阿里云。本文选择**非阿里云**。
    -   **峰值带宽的范围**：输入业务高峰期需要的带宽用量，单位是Mbps。本文输入**10**。
    -   **最大并发连接数**：最大并发连接数定义了一个全球加速实例能够承载的最大连接数量。当实例上的连接超过规格定义的最大连接数时，新建连接请求将被丢弃。本文选择**5千**。
4.  单击**点击生成方案**。

    生成方案后，您可以查看系统根据您的加速业务智能推荐的加速方案。

    ![智能推荐方案](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4596827951/p103000.png)


## 步骤二：组合购买实例

您可以根据系统推荐的加速方案，组合购买加速业务所需要的加速实例和基础带宽包。

1.  单击**去组合购买**。

    ![组合购买入口](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8267958951/p103007.png)

2.  在购买页面，根据以下信息购买加速业务所需要的实例。

    -   **订购时间**：选择实例的订购时间。

        **说明：** 该订购时间是组合购买的所有实例的订购时间。例如，您选择订购时间为1年，即全球加速实例和基础带宽包的订购时间都为1年。

    -   **规格**：选择购买全球加速实例的规格。本文选择**小型Ⅰ（规格单元）**。
    -   **带宽类型**：选择购买基础带宽包的带宽类型。本文选择**精品加速带宽**。
3.  单击**立即购买**并完成支付。

4.  购买完成后，请将购买的基础带宽包绑定到全球加速实例上。具体操作，请参见[绑定基础带宽包](/cn.zh-CN/用户指南/基础带宽包/绑定基础带宽包.md)。


## 步骤三：添加加速区域

购买加速业务所需要的实例后，您便可以添加加速区域，指定访问后端服务的用户的所在地域并分配加速带宽。

1.  在**实例列表**页面，找到已创建的全球加速实例，单击实例ID。

2.  单击**加速区域**页签，然后在**亚太**页签下单击**添加接入地域**。

3.  在**添加加速区域**对话框，根据以下信息进行配置。

    -   **地域**：选择访问加速服务用户的所属地域。本文选择**中国（香港）**。
    -   **带宽**：选择加速服务的地域带宽。本文输入**10** Mbps。
    -   **IP地址协议**：选择用户接入全球加速服务的IP地址协议。本文选择**IPv4**。
4.  单击**确定**。

    添加成功后，全球加速会在接入地域分配一个加速IP，用来加速用户访问。

    ![加速IP](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7796363161/p84380.png)


## 步骤四：添加监听

监听负责检查连接请求。系统会根据您指定的端口和协议转发来自客户端的入站连接。

1.  在实例详情页面，单击**监听**页签，然后单击**添加监听**。

2.  在**配置监听和协议**配置向导页面，根据以下信息配置监听。

    ![监听](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5758506261/p293214.png)

    |配置|说明|
    |--|--|
    |**监听名称**|输入监听的名称。 名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短划线（-）。 |
    |**协议**|选择监听的协议类型。本文选择**TCP**。 |
    |**端口**|指定用来接收请求并向终端节点进行转发的监听端口，端口取值范围：**1~65499**。本文输入**80**。 |
    |**客户端亲和性**|选择是否保持客户端亲和性。保持客户端亲和性，即客户端访问有状态的应用程序时，可以将来自同一客户端的所有请求都定向到同一终端节点。本文选择**源IP**。 |

3.  单击**下一步**配置终端节点组。


## 步骤五：配置终端节点组

每个监听都关联一个终端节点组，通过指定要分发流量的地域，将终端节点组与监听关联。关联后，全球加速会将流量分配到与监听关联的终端节点组内的最佳终端节点。

1.  在**配置终端节点**配置向导页面，根据以下信息配置终端节点组。

    ![终端节点配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1924285261/p293187.png)

    |配置|说明|
    |--|--|
    |**节点组名称**|输入终端节点组的名称。 名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和短划线（-）。 |
    |**地域**|选择终端节点组所属的地域，即请求要访问的目标服务器的所属地域。本文选择**美国（硅谷）**。 |
    |**后端服务部署在**|选择后端服务部署在阿里云还是非阿里云。本文选择**非阿里云**。 |
    |**保持客户端源IP**|选择开启或关闭保持客户端源IP。开启后，后端服务器可以通过该功能获取客户端源IP。本文选择关闭保持客户端源IP。

**说明：** 目前，保持客户端源IP功能白名单开放，如需使用请[提交工单](https://selfservice.console.aliyun.com/ticket/category/ga/today)。 |
    |**终端节点**|终端节点是客户端请求访问的目标主机。您可以根据以下信息配置终端节点：     -   **后端服务类型**：选择**自定义域名**。
    -   **后端服务**：输入要加速的后端服务的域名。
    -   **权重**：输入终端节点权重，权重取值范围：**0~255**。全球加速根据您配置的权重按比例将流量路由到终端节点。

**说明：** 如果某个终端节点的权重设置为0，全球加速将终止向该终端节点分发流量，请您谨慎操作。 |

2.  单击**下一步**，确认监听和终端节点配置信息，再单击**提交**。


## 步骤六：配置CNAME

要启用CNAME加速服务，需要将您的加速域名指向全球加速实例分配的CNAME地址。

1.  登录 [域名解析控制台](https://dns.console.aliyun.com/#/dns/domainList)。

2.  在**域名解析**页面，找到目标域名，在**操作**列单击**解析设置**。

3.  单击**添加记录**，然后完成以下配置。

    1.  **记录类型**：选择**CNAME**。

    2.  **主机记录**：输入加速域名的前缀。

        -   如果您的加速域名为`testcdn.aliyun.com`，主机记录为`testcdn`。
        -   如果您的加速域名为`www.aliyun.com`，主机记录为`www`。
        -   如果您的加速域名为`aliyun.com`，主机记录为`@`。
        -   如果您的加速域名为`*.aliyun.com`，主机记录为`*`。
    3.  **解析线路**：选择**默认**。

    4.  **记录值**：输入全球加速实例分配的CNAME。

        ![CNAME](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5496958951/p84125.png)

    5.  **TTL**：选择**10分钟**。

    6.  单击**确认**。

    **说明：**

    -   新增CNAME记录会实时生效，修改CNAME记录72小时之内生效。
    -   如果您遇到添加冲突问题，可以换一个加速域名或者调整冲突的记录，请参见[解析记录冲突](https://help.aliyun.com/knowledge_detail/39787.html)。
    -   配置完CNAME后，由于状态更新约有10分钟延迟，控制台的域名列表页可能仍提示“未配置CNAME”，请您暂时忽略。

## 步骤七：测试加速效果

**说明：** 如果全球加速配置的监听协议是UDP协议，您可以通过UDPing测试全球加速的加速效果。更多信息，请参见[测试UDP监听协议的加速效果](/cn.zh-CN/监控与运维/测试UDP监听协议的加速效果.md)。

1.  在接入地域（本文为中国香港）的电脑中打开命令行窗口。

2.  执行以下命令，查看数据包延迟情况。

    ```
    curl -o /dev/null -s -w "time_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n" ""http[s]://<终端节点域名>[:<端口>]""
    ```

    其中：

    -   time\_connect：连接时间，从开始到建立TCP连接完成所用的时间。
    -   time\_starttransfer：开始传输时间。在客户端发出请求后，到后端服务器响应第一个字节所用的时间。
    -   time\_total：连接总时间。客户端发出请求后，到后端服务器响应会话所用的时间。
    经测试，使用全球加速后，降低了中国香港办公点访问美国服务器上Web服务的延迟。

    ![加速前](../images/p93976.png "加速前的访问延迟情况")

    ![加速后](../images/p93977.png "加速后的访问延迟情况")


